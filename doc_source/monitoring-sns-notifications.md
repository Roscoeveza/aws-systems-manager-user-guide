# Monitoring Systems Manager status changes using Amazon SNS notifications<a name="monitoring-sns-notifications"></a>

You can configure Amazon Simple Notification Service \(Amazon SNS\) to send notifications about the status of commands that you send using Run Command or Maintenance Windows, which are capabilities of AWS Systems Manager\. Amazon SNS coordinates and manages sending and delivering notifications to clients or endpoints that are subscribed to Amazon SNS topics\. You can receive a notification whenever a command changes to a new state or to a specific state, such as *Failed* or *Timed Out*\. In cases where you send a command to multiple nodes, you can receive a notification for each copy of the command sent to a specific node\. Each copy is called an *invocation*\.

Amazon SNS can deliver notifications as HTTP or HTTPS POST, email \(SMTP, either plaintext or in JSON format\), or as a message posted to an Amazon Simple Queue Service \(Amazon SQS\) queue\. For more information, see [What is Amazon SNS](https://docs.aws.amazon.com/sns/latest/dg/) in the *Amazon Simple Notification Service Developer Guide*\. For examples of the structure of the JSON data included in the Amazon SNS notification provided by Run Command and Maintenance Windows, see [Example Amazon SNS notifications for AWS Systems Manager](monitoring-sns-examples.md)\.

## Configure Amazon SNS notifications for AWS Systems Manager<a name="monitoring-sns-configure"></a>

Run Command and Maintenance Windows tasks that are registered to a maintenance window can send Amazon SNS notifications for command tasks that enter the following statuses: 
+ In Progress
+ Success
+ Failed
+ Timed Out
+ Canceled

For information about the conditions that cause a command to enter one of these statuses, see [Understanding command statuses](monitor-commands.md)\.

**Note**  
Commands sent using Run Command also report Canceling and Pending status\. These statuses aren't captured by Amazon SNS notifications\.

### Command summary Amazon SNS notifications<a name="monitoring-sns-configure-summary"></a>

If you configure Run Command or a Run Command task in your maintenance window for Amazon SNS notifications, Amazon SNS sends summary messages that include the following information\.


****  

| Field | Type | Description | 
| --- | --- | --- | 
|  eventTime  |  String  |  The time that the event was initiated\. The timestamp is important because Amazon SNS doesn't guarantee message delivery order\. Example: 2016\-04\-26T13:15:30Z   | 
|  documentName  |  String  |  The name of the SSM document used to run this command\.  | 
|  commandId  |  String  |  The ID generated by Run Command after the command was sent\.  | 
|  expiresAfter  |  Date  |  If this time is reached and the command hasn't already started executing, it won't run\.   | 
|  outputS3BucketName  |  String  |  The Amazon Simple Storage Service \(Amazon S3\) bucket where the responses to the command execution should be stored\.  | 
|  outputS3KeyPrefix  |  String  |  The Amazon S3 directory path inside the bucket where the responses to the command execution should be stored\.  | 
|  requestedDateTime  |  String  |  The time and date that the request was sent to this specific node\.  | 
|  instanceIds  |  StringList  |  The nodes that were targeted by the command\.  Instance IDs are only included in the summary message if the Run Command task targeted instance IDs directly\. Instance IDs aren't included in the summary message if the Run Command task was issued using tag\-based targeting\.   | 
|  status  |  String  |  Command status for the command\.  | 

### Invocation\-based Amazon SNS notifications<a name="monitoring-sns-configure-invocation"></a>

If you send a command to multiple nodes, Amazon SNS can send messages about each copy or invocation of the command\. The messages include the following information\.


****  

| Field | Type | Description | 
| --- | --- | --- | 
|  eventTime  |  String  |  The time that the event was initiated\. The timestamp is important because Amazon SNS doesn't guarantee message delivery order\. Example: 2016\-04\-26T13:15:30Z   | 
|  documentName  |  String  |  The name of the Systems Manager document \(SSM document\) used to run this command\.  | 
|  requestedDateTime  |  String  |  The time and date that the request was sent to this specific node\.  | 
|  commandId  |  String  |  The ID generated by Run Command after the command was sent\.  | 
|  instanceId  |  String  |  The instance that was targeted by the command\.  | 
|  status  |  String  |  Command status for this invocation\.  | 

To set up Amazon SNS notifications when a command changes status, complete the following tasks\.

**Note**  
If you aren't configuring Amazon SNS notifications for your maintenance window, then you can skip Task 5 later in this topic\.

**Topics**
+ [Command summary Amazon SNS notifications](#monitoring-sns-configure-summary)
+ [Invocation\-based Amazon SNS notifications](#monitoring-sns-configure-invocation)
+ [Task 1: Create and subscribe to an Amazon SNS topic](#monitoring-configure-sns)
+ [Task 2: Create an IAM policy for Amazon SNS notifications](#monitoring-iam-policy)
+ [Task 3: Create an IAM role for Amazon SNS notifications](#monitoring-iam-notifications)
+ [Task 4: Configure user access](#monitoring-sns-passpolicy)
+ [Task 5: Attach the iam:PassRole policy to your maintenance window role](#monitoring-sns-passpolicy-mw)

### Task 1: Create and subscribe to an Amazon SNS topic<a name="monitoring-configure-sns"></a>

An Amazon SNS *topic* is a communication channel that Run Command and Run Command tasks that are registered to a maintenance window use to send notifications about the status of your commands\. Amazon SNS supports different communication protocols, including HTTP/S, email, and other AWS services like Amazon Simple Queue Service \(Amazon SQS\)\. To get started, we recommend that you start with the email protocol\. For information about how to create a topic, see [Creating an Amazon SNS topic](https://docs.aws.amazon.com/sns/latest/dg/sns-create-topic.html) in the *Amazon Simple Notification Service Developer Guide*\.

**Note**  
After you create the topic, copy or make a note of the **Topic ARN**\. You specify this ARN when you send a command that is configured to return status notifications\.

After you create the topic, subscribe to it by specifying an **Endpoint**\. If you chose the Email protocol, the endpoint is the email address where you want to receive notifications\. For more information about how to subscribe to a topic, see [Subscribing to an Amazon SNS topic](https://docs.aws.amazon.com/sns/latest/dg/sns-create-subscribe-endpoint-to-topic.html) in the *Amazon Simple Notification Service Developer Guide*\.

Amazon SNS sends a confirmation email from *AWS Notifications* to the email address that you specify\. Open the email and choose the **Confirm subscription** link\.

You will receive an acknowledgement message from AWS\. Amazon SNS is now configured to receive notifications and send the notification as an email to the email address that you specified\.

### Task 2: Create an IAM policy for Amazon SNS notifications<a name="monitoring-iam-policy"></a>

Use the following procedure to create a custom AWS Identity and Access Management \(IAM\) policy that provides permissions for inititating Amazon SNS notifications\.

**To create a custom IAM policy for Amazon SNS notifications**

1. Open the IAM console at [https://console\.aws\.amazon\.com/iam/](https://console.aws.amazon.com/iam/)\.

1. In the navigation pane, choose **Policies**, and then choose **Create Policy**\. \(If a **Get Started** button is shown, choose it, and then choose **Create Policy**\.\)

1. Choose the **JSON** tab\.

1. Replace the default content with the following\.

   ```
   {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Action": [
                   "sns:Publish"
               ],
               "Resource": "arn:aws:sns:region:account-id:sns-topic-name"
           }
       ]
   }
   ```

   *region* represents the identifier for an AWS Region supported by AWS Systems Manager, such as `us-east-2` for the US East \(Ohio\) Region\. For a list of supported *region* values, see the **Region** column in [Systems Manager service endpoints](https://docs.aws.amazon.com/general/latest/gr/ssm.html#ssm_region) in the *Amazon Web Services General Reference*\.

   **account\-id** represents the 12\-digit identifier for your AWS account, in the format `123456789012`\. 

   *sns\-topic\-name* represents the name of the Amazon SNS topic you want to use for publishing notifications\.

   

1. Choose **Next: Tags**\.

1. \(Optional\) Add one or more tag\-key value pairs to organize, track, or control access for this policy\. 

1. Choose **Next: Review**\.

1. On the **Review policy** page, for **Name**, enter a name for the inline policy\. For example: **my\-sns\-publish\-permissions**\.

1. \(Optional\) For **Description**, enter a description for the policy\.

1. Choose **Create policy**\.

### Task 3: Create an IAM role for Amazon SNS notifications<a name="monitoring-iam-notifications"></a>

Use the following procedure to create an IAM role for Amazon SNS notifications\. This service role is used by Systems Manager to initiate Amazon SNS notifications\. In all subsequent procedures, this role is referred to as the Amazon SNS IAM role\.

**To create an IAM service role for Amazon SNS notifications**

1. Open the IAM console at [https://console\.aws\.amazon\.com/iam/](https://console.aws.amazon.com/iam/)\.

1. In the navigation pane, choose **Roles**, and then choose **Create role**\.

1. Under **Select type of trusted entity**, choose **AWS service**\.

1. In the **Choose a use case** section, choose **Systems Manager**\. 

1. In the **Select your use case** section, choose **Systems Manager**, and then choose **Next: Permissions**\.

1. On the **Attach permissions policies** page, select the box to the left of the name of the custom policy you created in Task 2\. For example: **my\-sns\-publish\-permissions**\.

1. Choose **Next: Tags**\.

1. \(Optional\) Add one or more tag\-key value pairs to organize, track, or control access for this role\. 

1. Choose **Next: Review**\. 

1. On the **Review** page, for **Role name**, enter a name to identify the role, such as **my\-sns\-role**\. 

1. \(Optional\) Change the default role description to reflect the purpose of this role\. For example: **Runs Amazon SNS topics on your behalf\.**

1. Choose **Create role**\. The system returns you to the **Roles** page\.

1. Choose the name of the role, and then copy or make a note of the **Role ARN** value\. This Amazon Resource Name \(ARN\) for the role is used when you send a command that is configured to return Amazon SNS notifications\.

1. Keep the **Summary** page open\.

### Task 4: Configure user access<a name="monitoring-sns-passpolicy"></a>

If your IAM user account, group, or role is assigned administrator permissions, then you have access to Run Command and Maintenance Windows, capabilities of AWS Systems Manager\. If you don't have administrator permissions, then an administrator must give you permission by assigning the `AmazonSSMFullAccess` managed policy, or a policy that provides comparable permissions, to your IAM account, group, or role\. 

Use the following procedure to configure a user account to use Run Command and Maintenance Windows\. If you need to create a new user account, see [Creating an IAM user in your AWS account](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html) in the *IAM User Guide*\.

**To configure user access and attach the `iam:PassRole` policy to a user account**

1. In the IAM navigation pane, choose **Users**, and then choose the user account that you want to configure\.

1. On the **Permissions** tab, in the policies list, verify that either the **AmazonSSMFullAccess** policy is listed or that there is a comparable policy that gives the account permissions to access Systems Manager\.

1. Choose **Add inline policy**\.

1. On the **Create policy** page, choose the **Visual editor** tab\.

1. Choose **Choose a service**, and then choose ** IAM**\.

1. For **Actions**, in the **Filter actions** text box, enter **PassRole**, and then select the check box next to **PassRole**\.

1. For **Resources**, verify that **Specific** is selected, and then choose **Add ARN**\.

1. In the **Specify ARN for role** field, paste the Amazon SNS IAM role ARN that you copied at the end of Task 3\. The system automatically populates the **Account** and **Role name with path** fields\.

1. Choose **Add**\.

1. Choose **Review policy**\.

1. On the **Review Policy** page, enter a name and then choose **Create policy**\.

### Task 5: Attach the iam:PassRole policy to your maintenance window role<a name="monitoring-sns-passpolicy-mw"></a>

When you register a Run Command task with a maintenance window, you specify a service role Amazon Resource Name \(ARN\)\. This service role is used by Systems Manager to run tasks registered to the maintenance window\. To configure Amazon SNS notifications for a registered Run Command task, attach an `iam:PassRole` policy to the maintenance window service role specified\. If you don't intend to configure the registered task for Amazon SNS notifications, then you can skip this task\.

The `iam:PassRole` policy allows the Maintenance Windows service role to pass the Amazon SNS IAM role created in Task 3 to the Amazon SNS service\. The following procedure shows how to attach the `iam:PassRole` policy to the Maintenance Windows service role\.

**Note**  
Use a custom service role for your maintenance window to send notifications related to the Run Command tasks registered\. For information, see [Setting up Maintenance Windows](sysman-maintenance-permissions.md)\.  
If you need to create a custom service role for maintenance window tasks, see [Use the console to configure permissions for maintenance windows](sysman-maintenance-perm-console.md)\.

**To attach the` iam:PassRole` policy to your Maintenance Windows role**

1. Open the IAM console at [https://console\.aws\.amazon\.com/iam/](https://console.aws.amazon.com/iam/)\.

1. In the navigation pane, choose **Roles** and select the Amazon SNS IAM role created in Task 3\.

1. Copy or make a note of the **Role ARN** and return to the **Roles** section of the IAM console\.

1. Select the custom Maintenance Windows service role you created from the **Role name** list\.

1. On the **Permissions** tab, verify that either the `AmazonSSMMaintenanceWindowRole` policy is listed or there is a comparable policy that gives maintenance windows permission to the Systems Manager API\. If it is not, choose **Attach policies** to attach it\.

1. Choose **Add inline policy**\.

1. Choose the **Visual editor** tab\.

1. For **Service**, choose **IAM**\.

1. For **Actions**, in the **Filter actions** text box, enter **PassRole**, and then select the check box next to **PassRole**\.

1. For **Resources**, choose **Specific**, and then choose **Add ARN**\.

1. In the **Specify ARN for role** box, paste the ARN of the Amazon SNS IAM role created in Task 3, and then choose **Add**\.

1. Choose **Review policy**\.

1. On the **Review Policy** page, specify a name for the `PassRole` policy, and then choose **Create policy**\.